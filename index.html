<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Pre-Production Planner - Tom's Odyssey Style</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
         {
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
        }
        .sketch-canvas {
            border: 2px dashed #d1d5db;
            cursor: crosshair;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.active {
            max-height: 2000px; /* Increased max-height for auto-resizing textareas */
        }
        .filter-active {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        /* Style for auto-resizing textareas */
        textarea {
            resize: vertical;
            min-height: 60px;
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fab fa-youtube text-red-500 mr-3"></i>
                YouTube Pre-Production Planner
            </h1>
            <p class="text-gray-600">Inspired by Tom's Odyssey Notion Template</p>
            <div class="mt-4 flex flex-wrap gap-2">
                <input type="text" id="projectTitle" placeholder="Project Title" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="date" id="projectDate" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="saveProject()" class="no-print bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                    <i class="fas fa-save mr-2"></i>Save Project
                </button>
                <button onclick="loadProject()" class="no-print bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                    <i class="fas fa-upload mr-2"></i>Load Project
                </button>
            </div>
        </header>

        <!-- Packaging Section -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-box-open text-blue-500 mr-3"></i>
                Packaging (51% of the work)
            </h2>
            
            <!-- Title Brainstorming -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Title Ideas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="titleIdeas">
                    <!-- Title inputs will be generated by JavaScript -->
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="addTitleIdea()" class="no-print bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                        <i class="fas fa-plus mr-2"></i>Add Title Idea
                    </button>
                    <button onclick="generateTitles()" class="no-print bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition">
                        <i class="fas fa-sparkles mr-2"></i>✨ Generate with AI
                    </button>
                </div>
            </div>

            <!-- Thumbnail Concepts -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Thumbnail Concepts</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sketch Ideas</label>
                        <canvas id="thumbnailSketch" class="sketch-canvas w-full h-64 bg-white rounded-md" width="400" height="300"></canvas>
                        <div class="mt-2 flex gap-2">
                            <button onclick="clearSketch()" class="no-print bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition">
                                Clear
                            </button>
                            <input type="color" id="sketchColor" value="#000000" class="no-print w-8 h-8 rounded border-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reference Thumbnails</label>
                        <textarea id="thumbnailReferences" placeholder="Paste thumbnail URLs or descriptions here..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- Story Structure & Scripting -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-film text-green-500 mr-3"></i>
                    3-Act Story Structure & Script
                </h2>
                <button onclick="generateScriptOutline()" class="no-print bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition">
                     <i class="fas fa-sparkles mr-2"></i>✨ Generate Script Outline with AI
                </button>
            </div>

            <!-- Act 1 -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <button onclick="toggleAct('act1')" class="w-full p-4 text-left bg-blue-50 hover:bg-blue-100 transition rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-play text-blue-500 mr-2"></i>
                        Act 1: Setup (Hook + Re-engagement + Character Introduction)
                    </h3>
                </button>
                <div id="act1Content" class="collapsible-content p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <textarea placeholder="Hook (Grab viewer's interest)" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act1-hook"></textarea>
                        <textarea placeholder="Re-engagement (Secondary storyline)" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act1-reengagement"></textarea>
                        <textarea placeholder="Character Introduction" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act1-character"></textarea>
                    </div>
                    <textarea placeholder="Full Act 1 Script..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act1-full"></textarea>
                </div>
            </div>

            <!-- Transition 1 -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <button onclick="toggleAct('transition1')" class="w-full p-4 text-left bg-yellow-50 hover:bg-yellow-100 transition rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-arrow-right text-yellow-500 mr-2"></i>
                        Transition: Story Setup (What viewer can expect)
                    </h3>
                </button>
                <div id="transition1Content" class="collapsible-content p-4">
                    <textarea placeholder="Set up the whole story of the video - what can the viewer expect..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="transition1"></textarea>
                </div>
            </div>

            <!-- Act 2 -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <button onclick="toggleAct('act2')" class="w-full p-4 text-left bg-green-50 hover:bg-green-100 transition rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-play text-green-500 mr-2"></i>
                        Act 2: Multiple Re-engagement Points
                    </h3>
                </button>
                <div id="act2Content" class="collapsible-content p-4">
                    <div id="talkingPoints" class="space-y-3 mb-4">
                        <!-- Talking points will be added dynamically -->
                    </div>
                    <button onclick="addTalkingPoint()" class="no-print bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition text-sm">
                        <i class="fas fa-plus mr-2"></i>Add Talking Point
                    </button>
                    <textarea placeholder="Full Act 2 Script..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-4" data-script="act2-full"></textarea>
                </div>
            </div>

            <!-- Transition 2 -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <button onclick="toggleAct('transition2')" class="w-full p-4 text-left bg-orange-50 hover:bg-orange-100 transition rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-arrow-right text-orange-500 mr-2"></i>
                        Transition: Build up to Climax
                    </h3>
                </button>
                <div id="transition2Content" class="collapsible-content p-4">
                    <textarea placeholder="Build up your story towards the climax..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="transition2"></textarea>
                </div>
            </div>

            <!-- Act 3 -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <button onclick="toggleAct('act3')" class="w-full p-4 text-left bg-red-50 hover:bg-red-100 transition rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-play text-red-500 mr-2"></i>
                        Act 3: Climax + "Goosh" Moment + Redirect
                    </h3>
                </button>
                <div id="act3Content" class="collapsible-content p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <textarea placeholder="Climax (Everything comes together)" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act3-climax"></textarea>
                        <textarea placeholder="Goosh moment (Unexpected feel-good)" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act3-goosh"></textarea>
                        <textarea placeholder="Redirect to next video" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act3-redirect"></textarea>
                    </div>
                    <textarea placeholder="Full Act 3 Script..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-script="act3-full"></textarea>
                </div>
            </div>
        </section>

        <!-- Shot List & Production Planning -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-video text-purple-500 mr-3"></i>
                Shot List & Production Planning
            </h2>

            <!-- Filters -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button onclick="filterShots('all')" class="filter-btn filter-active px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">All Shots</button>
                <button onclick="filterShots('a-roll')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">A-Roll</button>
                <button onclick="filterShots('b-roll')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">B-Roll</button>
                <button onclick="filterShots('screen-capture')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">Screen Capture</button>
                <button onclick="filterShots('act1')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">Act 1</button>
                <button onclick="filterShots('act2')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">Act 2</button>
                <button onclick="filterShots('act3')" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition text-sm">Act 3</button>
            </div>

            <!-- Add Shot Button -->
            <div class="mb-4">
                <button onclick="addShot()" class="no-print bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition">
                    <i class="fas fa-plus mr-2"></i>Add Shot
                </button>
                <button onclick="copyFromScript()" class="no-print bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition ml-2">
                    <i class="fas fa-copy mr-2"></i>Copy from Script
                </button>
            </div>

            <!-- Shot List Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2 text-left">Script Line</th>
                            <th class="border border-gray-300 p-2 text-left">Act</th>
                            <th class="border border-gray-300 p-2 text-left">Shot Type</th>
                            <th class="border border-gray-300 p-2 text-left">Camera Angle</th>
                            <th class="border border-gray-300 p-2 text-left">Motion</th>
                            <th class="border border-gray-300 p-2 text-left">Description</th>
                            <th class="border border-gray-300 p-2 text-left">Location</th>
                            <th class="no-print border border-gray-300 p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shotListBody">
                        <!-- Shots will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Production Notes -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-clipboard-list text-indigo-500 mr-3"></i>
                Production Notes
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Equipment Needed</h3>
                    <textarea id="equipmentNotes" placeholder="List cameras, lenses, microphones, lighting, etc..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Location Notes</h3>
                    <textarea id="locationNotes" placeholder="Shooting locations, permits, logistics..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Talent & Crew</h3>
                    <textarea id="talentNotes" placeholder="Cast, crew members, contact information..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Additional Notes</h3>
                    <textarea id="additionalNotes" placeholder="Any other important production notes..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm py-4">
            <p>Inspired by Tom's Odyssey YouTube Pre-production Template</p>
            <p class="mt-1">Created for better video planning and production workflow</p>
        </footer>
    </div>
    
    <!-- API Loading Modal -->
    <div id="loadingModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-500 mx-auto"></div>
            <p id="modalMessage" class="mt-4 text-gray-700 font-semibold">Generating with AI... Please wait.</p>
        </div>
    </div>


    <script>
        // Global counters and state
        let shotCounter = 0;
        let talkingPointCounter = 0;
        let titleCounter = 0;
        let currentFilter = 'all';

        // --- Gemini API Integration ---
        const API_KEY = ""; // Leave empty, handled by environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        const modal = document.getElementById('loadingModal');
        const modalMessage = document.getElementById('modalMessage');

        function showLoadingModal(message = "Generating with AI... Please wait.") {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideLoadingModal() {
            modal.classList.add('hidden');
        }
        
        async function callGeminiAPI(prompt) {
            showLoadingModal();
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                showLoadingModal("An error occurred. Please try again.");
                setTimeout(hideLoadingModal, 3000); // Show error for 3 seconds
                return null;
            } finally {
                // Don't hide modal immediately on success, let the calling function do it
                 if (modalMessage.textContent.includes("Generating")) {
                    // Only hide if it's not an error message
                 } else {
                    setTimeout(hideLoadingModal, 100);
                 }
            }
        }
        
        async function generateTitles() {
            const projectTitle = document.getElementById('projectTitle').value.trim();
            if (!projectTitle) {
                showLoadingModal("Please enter a Project Title first.");
                setTimeout(hideLoadingModal, 2000);
                return;
            }
            
            const prompt = `Generate 5 catchy, viral, SEO-friendly YouTube titles in English for a video about "${projectTitle}". Return them as a simple text list, separated by newlines. Do not include numbering or bullet points.`;
            
            const resultText = await callGeminiAPI(prompt);
            
            if(resultText) {
                const titleIdeas = resultText.split('\n').filter(t => t.trim() !== '');
                const titleContainer = document.getElementById('titleIdeas');
                titleContainer.innerHTML = ''; // Clear existing
                titleCounter = 0;
                
                titleIdeas.forEach(idea => {
                    addTitleIdea(false, idea);
                });

                // Ensure there are at least 2 fields if AI gives fewer
                while (titleCounter < 2) {
                    addTitleIdea(true);
                }
            }
            hideLoadingModal();
        }

        async function generateScriptOutline() {
             const projectTitle = document.getElementById('projectTitle').value.trim();
            if (!projectTitle) {
                showLoadingModal("Please enter a Project Title first to generate a script.");
                setTimeout(hideLoadingModal, 2500);
                return;
            }

            const prompt = `Create a detailed 3-act story structure script outline for a YouTube video titled "${projectTitle}". The entire output must be in Hinglish (Hindi written in Roman script).
            The outline should include:
            - Act 1 Hook: A strong opening to grab attention.
            - Act 1 Re-engagement: A secondary point or question.
            - Act 1 Character Introduction: Introduce the main character/subject.
            - Transition 1: Connect Act 1 to Act 2.
            - Act 2 Talking Points: At least 3 distinct talking points that form the main content.
            - Transition 2: Build suspense towards the climax.
            - Act 3 Climax: The peak of the story.
            - Act 3 Goosh moment: An unexpected, satisfying, or emotional moment.
            - Act 3 Redirect: A call to action or teaser for the next video.

            Format the output strictly using these keys followed by a colon and the content, with each on a new line. The keys must remain in English. For example:
            Act 1 Hook: [content in Hinglish]
            Act 2 Talking Point 1: [content in Hinglish]
            Act 2 Talking Point 2: [content in Hinglish]
            ...and so on.
            `;
            
            const resultText = await callGeminiAPI(prompt);

            if (resultText) {
                // Clear existing talking points
                document.getElementById('talkingPoints').innerHTML = '';
                talkingPointCounter = 0;

                const lines = resultText.split('\n');
                const scriptData = {};
                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length > 1) {
                        const key = parts[0].trim();
                        const value = parts.slice(1).join(':').trim();
                        scriptData[key] = value;
                    }
                });
                
                // Map keys to data-script attributes
                const mapping = {
                    'Act 1 Hook': 'act1-hook',
                    'Act 1 Re-engagement': 'act1-reengagement',
                    'Act 1 Character Introduction': 'act1-character',
                    'Transition 1': 'transition1',
                    'Transition 2': 'transition2',
                    'Act 3 Climax': 'act3-climax',
                    'Act 3 Goosh moment': 'act3-goosh',
                    'Act 3 Redirect': 'act3-redirect'
                };

                for (const key in mapping) {
                    if (scriptData[key]) {
                        const element = document.querySelector(`[data-script="${mapping[key]}"]`);
                        if(element) element.value = scriptData[key];
                    }
                }

                // Handle talking points separately
                for (let i = 1; i <= 5; i++) { // Check for up to 5 talking points
                    const key = `Act 2 Talking Point ${i}`;
                    if (scriptData[key]) {
                       addTalkingPoint(false, scriptData[key]);
                    }
                }
                 // Resize all textareas after populating
                document.querySelectorAll('textarea').forEach(autoResizeTextarea);
            }
            hideLoadingModal();
        }


        // --- End Gemini API Integration ---


        // Function to auto-resize textarea
        function autoResizeTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        // Initialize title inputs
        function initializeTitleInputs() {
            const container = document.getElementById('titleIdeas');
            container.innerHTML = ''; // Clear existing
            titleCounter = 0;
            addTitleIdea(true); // Add first initial title
            addTitleIdea(true); // Add second initial title
        }

        // Add a new title idea input
        function addTitleIdea(isInitial = false, value = '') {
            titleCounter++;
            const container = document.getElementById('titleIdeas');
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'flex items-center gap-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Title idea ${titleCounter}`;
            input.className = 'w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm';
            input.id = `title${titleCounter}`;
            input.value = value;
            
            inputWrapper.appendChild(input);

            if (!isInitial) {
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.className = 'no-print bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition text-sm';
                removeBtn.onclick = function() {
                    inputWrapper.remove();
                };
                inputWrapper.appendChild(removeBtn);
            }

            container.appendChild(inputWrapper);
        }

        // Initialize talking points
        function initializeTalkingPoints() {
            for (let i = 1; i <= 3; i++) {
                addTalkingPoint(true);
            }
        }

        // Initialize canvas for sketching
        function initializeCanvas() {
            const canvas = document.getElementById('thumbnailSketch');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            const startDrawing = (e) => { isDrawing = true; draw(e); };
            const stopDrawing = () => { if (isDrawing) { isDrawing = false; ctx.beginPath(); } };
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = document.getElementById('sketchColor').value;
                
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            canvas.addEventListener('touchend', stopDrawing);
        }

        // Clear sketch canvas
        function clearSketch() {
            const canvas = document.getElementById('thumbnailSketch');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Toggle act sections
        function toggleAct(actId) {
            const content = document.getElementById(actId + 'Content');
            content.classList.toggle('active');
            // After opening, resize any textareas inside
            if (content.classList.contains('active')) {
                setTimeout(() => {
                    content.querySelectorAll('textarea').forEach(autoResizeTextarea);
                }, 300); // Wait for transition to finish
            }
        }

        // Add talking point
        function addTalkingPoint(isInitial = false, value = '') {
            talkingPointCounter++;
            const container = document.getElementById('talkingPoints');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Talking Point ${talkingPointCounter}`;
            input.className = 'flex-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm';
            input.dataset.script = `talking-point-${talkingPointCounter}`;
            input.value = value;
            
            div.appendChild(input);

            if (!isInitial) {
                 const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.className = 'no-print bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition text-sm';
                removeBtn.onclick = function() { div.remove(); };
                div.appendChild(removeBtn);
            }
            container.appendChild(div);
        }

        // Add shot to shot list
        function addShot() {
            shotCounter++;
            const tbody = document.getElementById('shotListBody');
            const row = document.createElement('tr');
            row.className = 'shot-row';
            row.innerHTML = `
                <td class="border border-gray-300 p-2">
                    <input type="text" placeholder="Script line..." class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="script-line">
                </td>
                <td class="border border-gray-300 p-2">
                    <select class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="act">
                        <option value="act1">Act 1</option>
                        <option value="act2">Act 2</option>
                        <option value="act3">Act 3</option>
                        <option value="transition">Transition</option>
                    </select>
                </td>
                <td class="border border-gray-300 p-2">
                    <select class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="shot-type">
                        <option value="a-roll">A-Roll</option>
                        <option value="b-roll">B-Roll</option>
                        <option value="screen-capture">Screen Capture</option>
                        <option value="cutaway">Cutaway</option>
                    </select>
                </td>
                <td class="border border-gray-300 p-2">
                    <select class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="camera-angle">
                        <option value="wide">Wide</option>
                        <option value="medium">Medium</option>
                        <option value="close-up">Close-up</option>
                        <option value="macro">Macro</option>
                        <option value="overhead">Overhead</option>
                    </select>
                </td>
                <td class="border border-gray-300 p-2">
                    <select class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="motion">
                        <option value="real-time">Real Time</option>
                        <option value="slow-motion">Slow Motion</option>
                        <option value="time-lapse">Time Lapse</option>
                        <option value="static">Static</option>
                    </select>
                </td>
                <td class="border border-gray-300 p-2">
                    <input type="text" placeholder="Shot description..." class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="description">
                </td>
                <td class="border border-gray-300 p-2">
                    <input type="text" placeholder="Location..." class="w-full p-1 border border-gray-200 rounded text-sm" data-shot="location">
                </td>
                <td class="no-print border border-gray-300 p-2">
                    <button onclick="this.closest('tr').remove()" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        // Copy from script to shot list
        function copyFromScript() {
            const scriptElements = document.querySelectorAll('[data-script]');
            let scriptContent = '';
            
            scriptElements.forEach(element => {
                if (element.value.trim()) {
                    scriptContent += element.value.trim() + '\n\n';
                }
            });
            
            if (scriptContent) {
                const lines = scriptContent.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    if (line.trim()) {
                        addShot();
                        const lastRow = document.querySelector('#shotListBody tr:last-child');
                        const scriptInput = lastRow.querySelector('[data-shot="script-line"]');
                        scriptInput.value = line.trim();
                    }
                });
            }
        }

        // Filter shots
        function filterShots(filter) {
            currentFilter = filter;
            const rows = document.querySelectorAll('.shot-row');
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const actSelect = row.querySelector('[data-shot="act"]');
                    const typeSelect = row.querySelector('[data-shot="shot-type"]');
                    
                    if ((actSelect && actSelect.value === filter) || (typeSelect && typeSelect.value === filter)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Save project
        function saveProject() {
            const projectData = {
                title: document.getElementById('projectTitle').value,
                date: document.getElementById('projectDate').value,
                titles: [],
                thumbnailReferences: document.getElementById('thumbnailReferences').value,
                scripts: {},
                shots: [],
                notes: {
                    equipment: document.getElementById('equipmentNotes').value,
                    location: document.getElementById('locationNotes').value,
                    talent: document.getElementById('talentNotes').value,
                    additional: document.getElementById('additionalNotes').value
                }
            };

            // Save titles dynamically
            document.querySelectorAll('#titleIdeas input').forEach(input => {
                if (input.value) {
                    projectData.titles.push(input.value);
                }
            });

            // Save scripts
            document.querySelectorAll('[data-script]').forEach(element => {
                projectData.scripts[element.dataset.script] = element.value;
            });

            // Save shots
            document.querySelectorAll('.shot-row').forEach(row => {
                const shot = {};
                row.querySelectorAll('[data-shot]').forEach(element => {
                    shot[element.dataset.shot] = element.value;
                });
                projectData.shots.push(shot);
            });

            // Download as JSON
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube-project-${projectData.title || 'untitled'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load project
        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const projectData = JSON.parse(e.target.result);
                            
                            // Load basic info
                            document.getElementById('projectTitle').value = projectData.title || '';
                            document.getElementById('projectDate').value = projectData.date || '';
                            
                            // Load titles dynamically
                            const titleContainer = document.getElementById('titleIdeas');
                            titleContainer.innerHTML = '';
                            titleCounter = 0;
                            if (projectData.titles && projectData.titles.length > 0) {
                                projectData.titles.forEach((titleText, index) => {
                                    addTitleIdea(false, titleText);
                                });
                            } 
                            // Ensure at least 2 are present
                            while(titleContainer.childElementCount < 2) {
                                addTitleIdea(true);
                            }
                            
                            
                            // Load thumbnail references
                            document.getElementById('thumbnailReferences').value = projectData.thumbnailReferences || '';
                            
                            // Load scripts
                            if (projectData.scripts) {
                                document.querySelectorAll('[data-script]').forEach(element => {
                                    element.value = projectData.scripts[element.dataset.script] || '';
                                });
                            }
                            
                            // Load shots
                            const tbody = document.getElementById('shotListBody');
                            tbody.innerHTML = '';
                            if (projectData.shots) {
                                projectData.shots.forEach(shotData => {
                                    addShot();
                                    const lastRow = tbody.lastElementChild;
                                    lastRow.querySelectorAll('[data-shot]').forEach(element => {
                                        element.value = shotData[element.dataset.shot] || '';
                                    });
                                });
                            }
                            
                            // Load notes
                            if (projectData.notes) {
                                document.getElementById('equipmentNotes').value = projectData.notes.equipment || '';
                                document.getElementById('locationNotes').value = projectData.notes.location || '';
                                document.getElementById('talentNotes').value = projectData.notes.talent || '';
                                document.getElementById('additionalNotes').value = projectData.notes.additional || '';
                            }
                            
                            // Resize all textareas after loading content
                            document.querySelectorAll('textarea').forEach(autoResizeTextarea);
                            
                            showLoadingModal('Project loaded successfully!');
                            setTimeout(hideLoadingModal, 1500);

                        } catch (error) {
                            showLoadingModal('Error loading project file: ' + error.message);
                            setTimeout(hideLoadingModal, 3000);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTitleInputs();
            initializeTalkingPoints();
            initializeCanvas();
            
            // Add some initial shots
            for (let i = 0; i < 3; i++) {
                addShot();
            }

            // Add auto-resize listener to all textareas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('input', () => autoResizeTextarea(textarea));
                // Initial resize on load
                autoResizeTextarea(textarea);
            });
        });
    </script>
</body>
</html>

